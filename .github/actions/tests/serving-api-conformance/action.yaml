# Copyright 2022 Chainguard, Inc.
# SPDX-License-Identifier: Apache-2.0

name: Serving API Conformance
description: Steps to run Knative Serving's API conformance suite.

runs:
  using: "composite"
  steps:
    - name: Check out upstream code
      uses: actions/checkout@v3
      with:
        repository: knative/serving
        path: ./src/knative.dev/serving

    - name: Upload test images
      working-directory: ./src/knative.dev/serving
      shell: bash
      run: |
        # These tests won't pass if we default to cluster-local...
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: config-domain
          namespace: hakn-system
        data:
          example.com: ""
        EOF

        # This is to fix errorcondition_test
        kubectl patch configmap/config-deployment \
          --namespace hakn-system \
          --type merge \
          --patch '{"data":{"progressDeadline":"120s"}}'

        ./test/upload-test-images.sh

        kubectl create namespace serving-tests

        # Make sure the things going to system namespace make it!
        [[ ! -d ./test/config ]] || ko resolve -Pf test/config | \
           sed -E "s/knative-serving/hakn-system/g" | \
           kubectl apply -f -

        # Needed for knative/serving e2e test
        [[ ! -d ./test/config/resource-quota ]] || ko resolve -Pf test/config/resource-quota | \
           sed -E "s/knative-serving/hakn-system/g" | \
           kubectl apply -f -

    - name: Run e2e Tests
      working-directory: ./src/knative.dev/serving
      shell: bash
      env:
        SYSTEM_NAMESPACE: hakn-system
      run: |
        # TODO: Dig into why this hits 5xx
        sed -i 's/func TestServiceCreateAndUpdate/func testServiceCreateAndUpdate/g' test/conformance/api/v1/service_test.go

        go test -race -count=1 -timeout=50m -tags=e2e \
          ./test/conformance/api/...
